<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Feather</title>

  
  <meta name="author" content="Feather">
  

  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="Feather"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Feather" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">Feather</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
        <li><a href="/about-me">About</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    
  <article>

  
    
    <h3 class="article-title"><a href="/2017/02/23/strongswan_ikev2/"><span>Strongswan 配置免证书IKEv2 VPN</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2017/02/23/strongswan_ikev2/" rel="bookmark">
        <time class="entry-date published" datetime="2017-02-23T10:09:37.000Z">
          2017-02-23
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>之前根据<a href="https://quericy.me/blog/699/" target="_blank" rel="external">CentOS/Ubuntu一键安装IPSEC/IKEV2 VPN服务器</a> 搭建一个VPN服务器，这套方案里面提供了两种方式连接IPSec（即IKEv1）和IKEv2，前者可以通过帐号、密码以及密钥PSK 即可连接，比较方便。后者需要证书，比较麻烦。所以我使用了IPsec作为产品的最终方案。</p>
<p>最近突然想起这件事情，加上之前调研的实践让我记得IKEv2方案其实更加安全并且稳定。『稳定』的表现是，可以在切换网络依然保持VPN不断开，这是一种不错的体验。所以，打算把目前方案迁移为IKEv2，所以做了一下调研。</p>
<p>首先是『无证书』问题。对于IKEv2，之前有了解到是可以实现无证书连接，这点很重要，不然得引导用户安装证书才能连接，体验会很差。今天用了蛮多时间调研，发现很多文章里面说的『无证书』并不是指完全不用证书，而是是指客户端连接之前不需要配置证书，但服务器端依然需要。所以，大部分文章提到的IKEv2有两种连接方案是这样的：</p>
<ol>
<li>服务器使用自签发证书，客户端需要提前安装配套证书</li>
<li>服务器使用CA证书，则客户端则可免证书</li>
</ol>
<p>这两个办法都不是真正的免证书，但是根据<a href="https://zorro.im/strongswan-ikev2-for-ios-without-certificate/" target="_blank" rel="external">用 strongSwan 搭建免证书的 IKEv2 VPN</a> 一文描述，确实可以通过PSK密钥代替证书实现服务器和客户端都无证书的方案，但是这个方案在设置GUI中无法配置，只能通过添加描述文件来配置，挺扯蛋的。但是，我发现这个办法在通过程序配置也是可以的，后面会详细介绍。</p>
<ol>
<li>服务器使用PSK密钥验证，客户端添加带PSK的VPN配置描述文件</li>
<li>服务器使用PSK密钥验证，客户端通过程序添加带PSK的VPN配置</li>
</ol>
<p>下面，只讨论比较有用的2和4方案。</p>
<h4 id="服务器使用CA证书，则客户端则可免证书"><a href="#服务器使用CA证书，则客户端则可免证书" class="headerlink" title="服务器使用CA证书，则客户端则可免证书"></a>服务器使用CA证书，则客户端则可免证书</h4><p>首先，弄个CA证书，CA证书很多免费的，这边查到了比较多人使用的是Let’s Encrypt SSL，但是有一个缺点就是需要定时续期。以下是配置步骤：</p>
<p><strong>1.安装Let’s Encrypt SSL的客户端</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/letsencrypt/letsencrypt</div><div class="line">cd letsencrypt</div><div class="line">./letsencrypt-auto --help</div></pre></td></tr></table></figure></p>
<p><strong>2.执行客户端申请证书，按照提示输入邮箱和域名就完成了</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./letsencrypt-auto certonly --server https://acme-v01.api.letsencrypt.org/directory --agree-dev-preview</div></pre></td></tr></table></figure></p>
<p><img src="http://vinqon.com/fms2/ROOT/image/certshell.jpg" alt="enter image description here"></p>
<p><strong>3.证书三个月后就过期，可以设定一个定时器，执行以下续期脚本</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo ~/.local/share/letsencrypt/bin/letsencrypt renew</div></pre></td></tr></table></figure></p>
<p><strong>4.把证书全部复制到strongswan一键安装脚本目录</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cp chain.pem /root/ca.cert.pem # 包括根证书的链证书</div><div class="line">cp cert.pem /root/server.cert.pem # 服务器证书</div><div class="line">cp privkey.pem /root/server.pem # 服务器私钥</div></pre></td></tr></table></figure></p>
<p><strong>5.然后就是安装Strongswan了，注意两点：</strong>  </p>
<p>1) 证书选择自己导入证书，否则脚本会自己生成自签发证书；<br>​<br><img src="http://vinqon.com/fms2/ROOT/image/strongswan.jpg" alt="enter image description here"></p>
<p>2) 安装完之后，需要去/usr/local/etc/ipsec.conf修改leftid，leftid需要和证书的域名保持一致，域名可以不指向本机IP，就是说一个有效证书可以用在多个Strongswan VPN的服务器上；</p>
<p><img src="http://vinqon.com/fms2/ROOT/image/leftid.jpg" alt="enter image description here"></p>
<ol>
<li>启动Strongswan之后，就用手机连接了。下面是系统VPN设置页面的配置Demo，通过程序连接基本同理；</li>
</ol>
<p><img src="http://vinqon.com/fms2/ROOT/image/iphoneconfig2.jpg" width="320px"></p>
<h4 id="服务器使用PSK密钥验证，客户端通过程序添加带PSK的VPN配置"><a href="#服务器使用PSK密钥验证，客户端通过程序添加带PSK的VPN配置" class="headerlink" title="服务器使用PSK密钥验证，客户端通过程序添加带PSK的VPN配置"></a>服务器使用PSK密钥验证，客户端通过程序添加带PSK的VPN配置</h4><p>这个办法其实很简单，但是用了我蛮多时间去摸索这些配置信息的。下面是服务器的配置方法，打开<code>/usr/local/etc/ipsec.conf</code>，然后加上下面这段配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">conn ios_ikev2_xauth_psk</div><div class="line">        keyexchange=ikev2</div><div class="line">        leftid=okvpn</div><div class="line">        left=%defaultroute</div><div class="line">        leftauth=psk</div><div class="line">        leftsubnet=0.0.0.0/0</div><div class="line">        right=%any</div><div class="line">        rightauth=eap-mschapv2</div><div class="line">        rightsourceip=10.31.2.0/24</div><div class="line">        rightsendcert=never</div><div class="line">        eap_identity=%any</div><div class="line">        dpdaction=clear</div><div class="line">        fragmentation=yes</div><div class="line">        auto=add</div></pre></td></tr></table></figure>
<p>然后，客户端的配置和IPSec的方法基本一直，但是要主要改两个地方：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> p = <span class="type">NEVPNProtocolIPSec</span>()</div><div class="line"><span class="keyword">if</span> vpnServer?.objectForKey(<span class="string">"method"</span>) <span class="keyword">as</span>! <span class="type">String</span>? == <span class="string">"ikev2"</span> &#123;</div><div class="line">	p = <span class="type">NEVPNProtocolIKEv2</span>()</div><div class="line">	p.remoteIdentifier = <span class="string">"okvpn"</span></div><div class="line">&#125;</div><div class="line">p.username = <span class="keyword">self</span>.username</div><div class="line">p.serverAddress = <span class="type">VPN_IP_ADDRESS</span></div><div class="line">p.passwordReference = keychain[attributes: <span class="string">"vpnpassword"</span>]!.persistentRef</div><div class="line">p.authenticationMethod = .<span class="type">SharedSecret</span></div><div class="line">p.sharedSecretReference = keychain[attributes: <span class="string">"sharedSecret"</span>]!.persistentRef</div><div class="line">p.useExtendedAuthentication = <span class="literal">true</span></div></pre></td></tr></table></figure>
<h4 id="Reference"><a href="#Reference" class="headerlink" title="Reference:"></a>Reference:</h4><p><a href="https://wiki.strongswan.org/projects/strongswan/wiki/AppleIKEv2Profile" target="_blank" rel="external">IKEv2 Configuration Profile for Apple iOS 8 and newer</a><br><a href="https://linsir.org/post/Strongswan-not-import-certs-and-some-tips" target="_blank" rel="external">Strongswan IKEV2免导入证书配置及调试笔记</a><br><a href="https://zorro.im/strongswan-ikev2-for-ios-without-certificate/" target="_blank" rel="external">用 strongSwan 搭建免证书的 IKEv2 VPN</a><br><a href="https://shanbin.name/lets-encrypt-ssl-certificates-for-free/" target="_blank" rel="external">申请免费的Let’s Encrypt SSL证书</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Tech/">Tech</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/ikev2/">ikev2</a><a href="/tags/vpn/">vpn</a><a href="/tags/strongwans/">strongwans</a>
    </span>
    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2017/02/23/strongswan_ikev2/#comment">Comments</a>
        </span>
      </span>
    </div>
    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2017/02/23/prewords/"><span>前言</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2017/02/23/prewords/" rel="bookmark">
        <time class="entry-date published" datetime="2017-02-23T08:48:10.000Z">
          2017-02-23
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>最近准备离开Misfit，我就想把过去两年做过的一些事情梳理一下。</p>
<p>于是，我打开了大学的时候建的那个<a href="http://vinqon.com/codeblog/" target="_blank" rel="external">技术博客</a>，觉得阅读体验太差了，而且现在都习惯用Markdown来写东西，那个后台还只支持html编辑器。重点是，那货是用ASP.NET写的，我应该都有6年没写了吧，环境搭起来再改也费劲，于是就随大流在Github上搭了一个基于<a href="http://hexo.io" target="_blank" rel="external">Hexo</a>的静态Blog了，看着挺舒服的，后面的一些文章都写这里吧。</p>
<p>说起Blog，我用过还蛮多的。至今还保留的有三个：第一个是初中的时候自己搭的叫<a href="http://www.pjhome.net/" target="_blank" rel="external">PJBlog</a>的ASP开源博客系统。记得当时这个博客系统蛮出名的，普及率挺高，我也很崇拜那个作者，那时候作者只是一个大学生。后来，我也上大学了，大三的时候去了腾讯实习，在大族楼下碰到他，也不好意思搭讪，就在一旁默默地激动得不能自已。</p>
<p>后来这个Blog我没有维护了，源码和数据库都一直备份在磁盘里。高中的时候用QZone，写了一堆不堪回首的东西。上大学之后开始流行用网易博客，我又随大流，在那里记录了很多生活的东西。再后来，因为想记录一下技术的一些学习笔记，当时搞Web搞得正High，于是就自己用ASP.NET写了一个<a href="http://vinqon.com/codeBlog" target="_blank" rel="external">技术博客</a>。这上面有很多彩蛋，也有很多以前写过的小玩意，这也是我不舍得关掉的原因。</p>
<p>譬如说，博客头部写的代码是博客栏目结构的定义，而下面的面包屑导航中其实是可以输入的，根据定义的结构输入目标栏目，页面会自动跳到那个栏目。还有，当时做前端对IE6深恶痛绝，于是当用户用IE6，7进入我的Blog的时候会显示一屏『你有罪…』的诅咒。还有很多小玩具，譬如当时的<a href="http://vinqon.com/fms2/#/" target="_blank" rel="external">Web文件管理系统</a>, <a href="http://vinqon.com/webrebuilder/" target="_blank" rel="external">重构自动化工具</a>, <a href="http://vinqon.com/psyexperiment/" target="_blank" rel="external">给妹子做的心理学实验工具</a>, <a href="http://vinqon.com/csspacker/" target="_blank" rel="external">CSS精简器</a>, <a href="http://vinqon.com/itools/" target="_blank" rel="external">OCModel生成工具</a>…</p>
<p>包括生活博客和技术博客，最近一次记事至今已经近4年了，这4年其实发生了很多事情，很多改变了一生的事情，很多值得回忆的事情。从14年开始吧，我基本每年坚持至少3趟出国旅行，走过不少路，看了不少风景，却一篇游记也没留下。</p>
<p>希望以后能把这些债补回来吧。</p>
<p>所以，又翻篇了。</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Others/">Others</a>
    </span>
    

    

    </div>

    
    <div class="article-meta pull-right">
      <span>
        <i class="icon-comments"></i>
        <span>
          <a href="/2017/02/23/prewords/#comment">Comments</a>
        </span>
      </span>
    </div>
    
  </div>
</article>




<nav class="pagination">
  
  
</nav>
    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2017 Feather
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>